# 用户登录系统流程图

本文档描述了基于手机号验证码的登录系统流程，包括首次登录、老用户一键登录、国家代码选择等核心流程。

---

## 一、应用启动与认证检查流程

```mermaid
flowchart TD
    Start([用户打开APP]) --> ShowSplash[显示启动画面]
    ShowSplash --> InitApp[初始化应用]
    
    InitApp --> CheckLocalToken{检查本地Token}
    
    CheckLocalToken -->|无Token| NoAuth[未认证状态]
    CheckLocalToken -->|有Token| ValidateToken[验证Token有效性]
    
    ValidateToken --> SendTokenRequest[发送Token验证请求]
    SendTokenRequest --> ServerCheck{后端验证Token}
    
    ServerCheck -->|Token有效| LoadUserData[加载用户数据]
    ServerCheck -->|Token过期| TryRefresh{尝试刷新Token}
    
    TryRefresh -->|有Refresh Token| SendRefreshRequest[发送刷新请求]
    SendRefreshRequest --> RefreshResult{刷新成功?}
    
    RefreshResult -->|成功| SaveNewToken[保存新Token]
    SaveNewToken --> LoadUserData
    
    RefreshResult -->|失败| ClearOldToken[清除过期Token]
    TryRefresh -->|无Refresh Token| ClearOldToken
    
    ClearOldToken --> NoAuth
    
    LoadUserData --> UpdateAuthState[更新认证状态]
    UpdateAuthState --> NavigateHome[跳转到首页]
    
    NoAuth --> CheckSavedPhone{检查本地保存的手机号}
    CheckSavedPhone -->|有| NavigateOneClick[跳转到一键登录页面]
    CheckSavedPhone -->|无| NavigateLogin[跳转到登录页面]
    
    NavigateHome --> End([启动完成])
    NavigateOneClick --> End
    NavigateLogin --> End
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style LoadUserData fill:#fff4e1
    style NavigateHome fill:#e1f0ff
```

---

## 二、首次登录（新用户）流程

```mermaid
flowchart TD
    Start([进入登录页面]) --> ShowLoginUI[显示登录界面]
    
    ShowLoginUI --> InitialState[初始状态]
    InitialState --> DisplayCountryCode[显示国家代码 +86]
    InitialState --> DisplayPhoneInput[显示手机号输入框]
    InitialState --> DisplayAgreement[显示用户协议勾选框]
    InitialState --> DisplayNextButton[显示下一步按钮-禁用]
    
    DisplayPhoneInput --> UserInput{用户操作}
    
    UserInput -->|点击国家代码| OpenCountryPicker[打开国家代码选择器]
    OpenCountryPicker --> SelectCountry[选择国家/地区]
    SelectCountry --> UpdateCountryCode[更新国家代码]
    UpdateCountryCode --> UserInput
    
    UserInput -->|输入手机号| InputPhone[输入手机号]
    InputPhone --> ValidatePhoneFormat{实时验证格式}
    
    ValidatePhoneFormat -->|格式错误| KeepButtonDisabled[保持按钮禁用]
    KeepButtonDisabled --> UserInput
    
    ValidatePhoneFormat -->|格式正确| CheckAgreement{检查协议勾选}
    
    UserInput -->|点击协议勾选框| ToggleAgreement[切换勾选状态]
    ToggleAgreement --> CheckAgreement
    
    CheckAgreement -->|未勾选| ShowAgreementHint[提示需同意协议]
    ShowAgreementHint --> UserInput
    
    CheckAgreement -->|已勾选| EnableNextButton[启用下一步按钮]
    EnableNextButton --> UserAction{用户操作}
    
    UserAction -->|继续输入| UserInput
    UserAction -->|点击下一步| ClickNext[点击下一步按钮]
    
    ClickNext --> ShowLoading1[显示加载动画]
    ShowLoading1 --> SendSMSRequest[发送验证码请求]
    
    SendSMSRequest --> BackendCheck{后端检查}
    
    BackendCheck -->|频率限制| RateLimitError[返回频率限制错误]
    RateLimitError --> ShowRateLimitMsg[显示: 请60秒后再试]
    ShowRateLimitMsg --> HideLoading1[隐藏加载动画]
    HideLoading1 --> UserInput
    
    BackendCheck -->|手机号异常| PhoneError[返回手机号错误]
    PhoneError --> ShowPhoneError[显示错误信息]
    ShowPhoneError --> HideLoading1
    
    BackendCheck -->|检查通过| GenerateCode[生成4位数字验证码]
    GenerateCode --> SaveCodeToDB[保存验证码到数据库]
    SaveCodeToDB --> RecordMetadata[记录IP、设备信息]
    RecordMetadata --> SetExpiry[设置5分钟过期时间]
    SetExpiry --> CallSMSAPI[调用短信API发送]
    
    CallSMSAPI -->|发送失败| SMSAPIError[短信API错误]
    SMSAPIError --> LogError[记录错误日志]
    LogError --> ShowSMSError[显示: 发送失败请重试]
    ShowSMSError --> HideLoading1
    
    CallSMSAPI -->|发送成功| LogSMSSuccess[记录发送成功]
    LogSMSSuccess --> HideLoading2[隐藏加载动画]
    HideLoading2 --> SavePhoneTemp[临时保存手机号]
    SavePhoneTemp --> NavigateToCode[跳转到验证码页面]
    
    NavigateToCode --> End([进入验证码输入流程])
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style GenerateCode fill:#fff4e1
    style CallSMSAPI fill:#e1f0ff
```

---

## 三、验证码输入与验证流程

```mermaid
flowchart TD
    Start([进入验证码页面]) --> InitCodePage[初始化验证码页面]
    
    InitCodePage --> GetPhoneParam[获取手机号参数]
    GetPhoneParam --> ShowPhoneNumber[显示格式化的手机号]
    ShowPhoneNumber --> ShowCodeInputs[显示4个输入框]
    ShowCodeInputs --> StartCountdown[开始60秒倒计时]
    StartCountdown --> AutoFocusFirst[自动聚焦第一个输入框]
    
    AutoFocusFirst --> WaitInput{等待用户输入}
    
    WaitInput -->|输入数字| InputDigit[输入数字]
    InputDigit --> CheckPosition{检查输入位置}
    
    CheckPosition -->|第1-3位| AutoFocusNext[自动聚焦下一位]
    AutoFocusNext --> WaitInput
    
    CheckPosition -->|第4位| AllFilled[4位数字已填写]
    AllFilled --> AutoSubmit[自动提交验证]
    
    WaitInput -->|删除数字| DeleteDigit[删除数字]
    DeleteDigit --> CheckDeletePos{检查删除位置}
    CheckDeletePos -->|第2-4位| AutoFocusPrev[自动回退到上一位]
    AutoFocusPrev --> WaitInput
    CheckDeletePos -->|第1位| StayFirst[停留在第一位]
    StayFirst --> WaitInput
    
    AutoSubmit --> ShowVerifying[显示验证中...]
    ShowVerifying --> SendVerifyRequest[发送验证请求]
    
    SendVerifyRequest --> BackendVerify{后端验证}
    
    BackendVerify -->|验证码不存在| CodeNotFound[验证码不存在]
    BackendVerify -->|验证码已过期| CodeExpired[验证码已过期]
    BackendVerify -->|验证码错误| CodeWrong[验证码错误]
    
    CodeNotFound --> ShowErrorMsg1[显示: 验证码无效]
    CodeExpired --> ShowErrorMsg1
    
    CodeWrong --> IncrementAttempt[增加尝试次数]
    IncrementAttempt --> CheckAttempts{检查尝试次数}
    
    CheckAttempts -->|<3次| ShowErrorMsg2[显示: 验证码错误剩余X次]
    CheckAttempts -->|>=3次| LockAccount[锁定10分钟]
    LockAccount --> ShowLockMsg[显示: 尝试次数过多请稍后再试]
    ShowLockMsg --> NavigateBack[返回登录页]
    
    ShowErrorMsg1 --> HideVerifying1[隐藏加载状态]
    ShowErrorMsg2 --> HideVerifying1
    HideVerifying1 --> ClearInputs[清空输入框]
    ClearInputs --> WaitInput
    
    BackendVerify -->|验证成功| MarkCodeUsed[标记验证码已使用]
    MarkCodeUsed --> CheckUserExists{用户是否存在?}
    
    CheckUserExists -->|不存在-首次注册| CreateNewUser[创建新用户记录]
    CreateNewUser --> SetDefaultValues[设置默认值]
    SetDefaultValues --> SetPhoneVerified[设置手机号已验证]
    SetPhoneVerified --> GenerateUserTokens[生成JWT Tokens]
    
    CheckUserExists -->|存在-老用户| LoadUserInfo[加载用户信息]
    LoadUserInfo --> UpdateLastLogin[更新最后登录时间]
    UpdateLastLogin --> GenerateUserTokens
    
    GenerateUserTokens --> CreateAccessToken[创建Access Token 30分钟]
    GenerateUserTokens --> CreateRefreshToken[创建Refresh Token 7天]
    
    CreateAccessToken --> SaveSession[创建会话记录]
    CreateRefreshToken --> SaveSession
    SaveSession --> LogLoginSuccess[记录登录成功日志]
    
    LogLoginSuccess --> ReturnUserData[返回用户数据和Token]
    ReturnUserData --> SaveTokenLocal[保存Token到本地]
    SaveTokenLocal --> SavePhoneLocal[保存手机号到本地]
    SavePhoneLocal --> UpdateAuthState[更新认证状态]
    
    UpdateAuthState --> CheckIsNewUser{是否是新用户?}
    
    CheckIsNewUser -->|是| ShowWelcome[显示欢迎信息]
    ShowWelcome --> CheckProfileComplete{资料是否完善?}
    
    CheckProfileComplete -->|否| NavigateProfileSetup[跳转到资料完善页]
    CheckProfileComplete -->|是| NavigateHome
    
    CheckIsNewUser -->|否| NavigateHome[跳转到首页]
    
    WaitInput -->|倒计时结束| CountdownEnd[倒计时到0]
    CountdownEnd --> ShowResendButton[显示重新发送按钮]
    ShowResendButton --> UserAction{用户操作}
    
    UserAction -->|点击重新发送| ResendCode[重新发送验证码]
    ResendCode --> SendSMSRequest[发送验证码请求]
    SendSMSRequest --> RestartCountdown[重新开始倒计时]
    RestartCountdown --> WaitInput
    
    UserAction -->|点击返回| NavigateBack
    UserAction -->|继续输入| WaitInput
    
    NavigateHome --> End([登录完成])
    NavigateProfileSetup --> End
    NavigateBack --> End
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style GenerateUserTokens fill:#fff4e1
    style CreateNewUser fill:#e1f0ff
    style NavigateHome fill:#f0e1ff
```

---

## 四、老用户一键登录流程

```mermaid
flowchart TD
    Start([进入登录页面]) --> CheckLocalPhone{检查本地手机号}
    
    CheckLocalPhone -->|无保存| ShowNewUserUI[显示新用户登录界面]
    ShowNewUserUI --> End1([转到首次登录流程])
    
    CheckLocalPhone -->|有保存| GetMaskedPhone[获取脱敏手机号]
    GetMaskedPhone --> ShowReturningUI[显示老用户登录界面]
    
    ShowReturningUI --> DisplayMaskedPhone[显示: 152****4295]
    DisplayMaskedPhone --> DisplayCarrier[显示: 中国移动提供认证]
    DisplayCarrier --> DisplayOneClickBtn[显示一键登录按钮-启用]
    DisplayOneClickBtn --> DisplayOtherPhoneLink[显示换号登录链接]
    
    DisplayOneClickBtn --> UserChoice{用户选择}
    
    UserChoice -->|点击一键登录| ClickOneClick[点击一键登录]
    UserChoice -->|点击换号登录| ClickOtherPhone[点击换号登录]
    
    ClickOtherPhone --> ClearLocalData[清除本地数据]
    ClearLocalData --> ClearPhone[清除保存的手机号]
    ClearPhone --> ClearTokens[清除保存的Token]
    ClearTokens --> ShowNewUserUI
    
    ClickOneClick --> ShowLoadingBtn[按钮显示加载状态]
    ShowLoadingBtn --> CheckLocalToken{检查本地Token}
    
    CheckLocalToken -->|无Token| NoTokenFlow[无Token流程]
    CheckLocalToken -->|有Token| ValidateLocalToken[验证Token有效性]
    
    ValidateLocalToken --> SendTokenCheck[发送Token验证请求]
    SendTokenCheck --> TokenCheckResult{Token验证结果}
    
    TokenCheckResult -->|Token有效| DirectLogin[直接登录成功]
    DirectLogin --> LoadUserData1[加载用户数据]
    LoadUserData1 --> UpdateAuthState1[更新认证状态]
    UpdateAuthState1 --> ShowSuccess1[显示登录成功]
    ShowSuccess1 --> NavigateHome1[跳转到首页]
    
    TokenCheckResult -->|Token过期| TryRefreshToken{尝试刷新Token}
    
    TryRefreshToken -->|有Refresh Token| SendRefreshReq[发送刷新请求]
    SendRefreshReq --> RefreshResult{刷新结果}
    
    RefreshResult -->|刷新成功| SaveNewTokens[保存新Token]
    SaveNewTokens --> UpdateLocalStorage[更新本地存储]
    UpdateLocalStorage --> DirectLogin
    
    RefreshResult -->|刷新失败| ClearOldTokens[清除过期Token]
    TryRefreshToken -->|无Refresh Token| ClearOldTokens
    
    ClearOldTokens --> NoTokenFlow
    
    NoTokenFlow --> GetSavedPhone[获取保存的手机号]
    GetSavedPhone --> ShowSMSLoading[显示发送验证码加载]
    ShowSMSLoading --> AutoSendSMS[自动发送验证码]
    
    AutoSendSMS --> SendSMSRequest[发送验证码请求]
    SendSMSRequest --> SMSResult{发送结果}
    
    SMSResult -->|成功| HideSMSLoading[隐藏加载状态]
    HideSMSLoading --> NavigateCodePage[跳转到验证码页面]
    NavigateCodePage --> End2([进入验证码输入流程])
    
    SMSResult -->|失败| ShowSMSError[显示发送失败]
    ShowSMSError --> HideLoadingBtn[隐藏按钮加载]
    HideLoadingBtn --> ShowErrorMsg[显示错误提示]
    ShowErrorMsg --> RetryOption{提供重试选项}
    
    RetryOption -->|用户点击重试| ClickOneClick
    RetryOption -->|用户放弃| UserChoice
    
    NavigateHome1 --> End3([登录完成])
    
    style Start fill:#e1f5e1
    style End1 fill:#ffe1e1
    style End2 fill:#ffe1e1
    style End3 fill:#ffe1e1
    style DirectLogin fill:#e1f0ff
    style SaveNewTokens fill:#fff4e1
```

---

## 五、国家/地区代码选择流程

```mermaid
flowchart TD
    Start([点击国家代码区域]) --> OpenPickerPage[打开选择器页面]
    
    OpenPickerPage --> InitPicker[初始化选择器]
    InitPicker --> LoadCountryList[加载国家列表数据]
    
    LoadCountryList --> GetCurrentCode[获取当前选中的代码]
    GetCurrentCode --> ShowList[显示国家列表]
    ShowList --> HighlightCurrent[高亮当前选中项]
    
    HighlightCurrent --> ShowSearchBar[显示搜索栏]
    ShowSearchBar --> ShowCountries[显示所有国家]
    
    ShowCountries --> UserAction{用户操作}
    
    UserAction -->|滚动列表| ScrollList[滚动浏览列表]
    ScrollList --> ViewMoreCountries[查看更多国家]
    ViewMoreCountries --> UserAction
    
    UserAction -->|点击搜索框| FocusSearch[聚焦搜索框]
    FocusSearch --> InputSearch[输入搜索关键词]
    
    InputSearch --> SearchProcess{搜索处理}
    SearchProcess --> SearchByName[按国家名称搜索]
    SearchProcess --> SearchByCode[按国家代码搜索]
    SearchProcess --> SearchByDialCode[按电话代码搜索]
    
    SearchByName --> FilterResults[过滤匹配结果]
    SearchByCode --> FilterResults
    SearchByDialCode --> FilterResults
    
    FilterResults --> UpdateList[更新显示列表]
    UpdateList --> ShowFilteredResults{有匹配结果?}
    
    ShowFilteredResults -->|有| DisplayMatches[显示匹配的国家]
    ShowFilteredResults -->|无| DisplayEmpty[显示无匹配结果]
    
    DisplayMatches --> UserAction
    DisplayEmpty --> ClearSearch{清除搜索?}
    ClearSearch -->|是| ResetList[重置列表]
    ResetList --> ShowCountries
    ClearSearch -->|否| UserAction
    
    UserAction -->|点击国家项| SelectCountry[选择国家]
    
    SelectCountry --> GetSelectedCode[获取选中的代码]
    GetSelectedCode --> ConfirmSelection[确认选择]
    ConfirmSelection --> ClosePickerPage[关闭选择器页面]
    ClosePickerPage --> ReturnCode[返回选中的代码]
    
    ReturnCode --> UpdateLoginPage[更新登录页面]
    UpdateLoginPage --> DisplayNewCode[显示新的国家代码]
    DisplayNewCode --> SaveCodePreference[保存用户偏好可选]
    
    UserAction -->|点击返回按钮| CancelSelection[取消选择]
    CancelSelection --> ClosePickerKeep[关闭选择器]
    ClosePickerKeep --> KeepOriginalCode[保持原有代码]
    
    SaveCodePreference --> End([选择完成])
    KeepOriginalCode --> End
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style SelectCountry fill:#fff4e1
    style UpdateLoginPage fill:#e1f0ff
```

---

## 六、Token刷新流程

```mermaid
flowchart TD
    Start([触发Token刷新]) --> CheckRefreshToken{检查Refresh Token}
    
    CheckRefreshToken -->|不存在| NoRefreshToken[无Refresh Token]
    NoRefreshToken --> ClearAuthState[清除认证状态]
    ClearAuthState --> RedirectLogin[重定向到登录页]
    
    CheckRefreshToken -->|存在| ValidateRefreshFormat{验证Token格式}
    
    ValidateRefreshFormat -->|格式错误| InvalidFormat[Token格式错误]
    InvalidFormat --> ClearAuthState
    
    ValidateRefreshFormat -->|格式正确| SendRefreshRequest[发送刷新请求]
    SendRefreshRequest --> AddAuthHeader[添加Authorization Header]
    AddAuthHeader --> CallRefreshAPI[调用/api/v1/auth/refresh-token]
    
    CallRefreshAPI --> APIResponse{API响应}
    
    APIResponse -->|网络错误| NetworkError[网络连接失败]
    NetworkError --> ShowErrorMsg[显示错误提示]
    ShowErrorMsg --> RetryOption{提供重试选项}
    
    RetryOption -->|用户重试| SendRefreshRequest
    RetryOption -->|用户取消| ClearAuthState
    
    APIResponse -->|Token过期| RefreshTokenExpired[Refresh Token过期]
    APIResponse -->|Token无效| RefreshTokenInvalid[Refresh Token无效]
    APIResponse -->|账号异常| AccountBlocked[账号被封禁]
    
    RefreshTokenExpired --> LogRefreshFailed[记录刷新失败日志]
    RefreshTokenInvalid --> LogRefreshFailed
    AccountBlocked --> LogRefreshFailed
    
    LogRefreshFailed --> ClearAuthState
    
    APIResponse -->|刷新成功| GetNewTokens[获取新的Tokens]
    GetNewTokens --> ParseResponse[解析响应数据]
    ParseResponse --> ExtractAccessToken[提取Access Token]
    ParseResponse --> ExtractExpiresIn[提取过期时间]
    
    ExtractAccessToken --> ValidateNewToken{验证新Token}
    
    ValidateNewToken -->|无效| TokenValidationFail[Token验证失败]
    TokenValidationFail --> LogError[记录错误日志]
    LogError --> ClearAuthState
    
    ValidateNewToken -->|有效| SaveNewToken[保存新Token到本地]
    SaveNewToken --> UpdateSharedPreferences[更新SharedPreferences]
    UpdateSharedPreferences --> UpdateAuthProvider[更新AuthProvider状态]
    
    UpdateAuthProvider --> CalculateNextRefresh[计算下次刷新时间]
    CalculateNextRefresh --> SetRefreshTimer[设置刷新定时器]
    SetRefreshTimer --> LogRefreshSuccess[记录刷新成功日志]
    
    LogRefreshSuccess --> RetryOriginalRequest{需要重试原请求?}
    
    RetryOriginalRequest -->|是| RetryWithNewToken[使用新Token重试]
    RetryWithNewToken --> End1([刷新完成])
    
    RetryOriginalRequest -->|否| ContinueFlow[继续应用流程]
    ContinueFlow --> End1
    
    RedirectLogin --> End2([需要重新登录])
    
    style Start fill:#e1f5e1
    style End1 fill:#e1f0ff
    style End2 fill:#ffe1e1
    style SaveNewToken fill:#fff4e1
```

---

## 七、退出登录流程

```mermaid
flowchart TD
    Start([用户点击退出登录]) --> ShowConfirmDialog{显示确认对话框}
    
    ShowConfirmDialog -->|用户取消| CancelLogout[取消退出]
    CancelLogout --> End1([保持登录状态])
    
    ShowConfirmDialog -->|用户确认| StartLogout[开始退出流程]
    StartLogout --> ShowLoadingIndicator[显示加载指示器]
    
    ShowLoadingIndicator --> GetAccessToken[获取当前Access Token]
    GetAccessToken --> SendLogoutRequest[发送退出登录请求]
    
    SendLogoutRequest --> CallLogoutAPI[调用/api/v1/auth/logout]
    CallLogoutAPI --> APIResponse{API响应}
    
    APIResponse -->|成功| ServerLogoutSuccess[服务器端登出成功]
    APIResponse -->|失败但Token已失效| TokenAlreadyInvalid[Token已失效]
    APIResponse -->|网络错误| NetworkError[网络连接失败]
    
    NetworkError --> LogNetworkError[记录网络错误]
    LogNetworkError --> ProceedLocalLogout[继续本地登出]
    
    ServerLogoutSuccess --> InvalidateSession[使会话失效]
    TokenAlreadyInvalid --> ProceedLocalLogout
    
    InvalidateSession --> LogLogoutSuccess[记录登出成功日志]
    LogLogoutSuccess --> ProceedLocalLogout[执行本地清理]
    
    ProceedLocalLogout --> ClearLocalTokens[清除本地Token]
    ClearLocalTokens --> ClearSavedPhone[清除保存的手机号]
    ClearSavedPhone --> ClearUserData[清除用户数据缓存]
    ClearUserData --> ClearAuthState[清除认证状态]
    
    ClearAuthState --> ResetAuthProvider[重置AuthProvider]
    ResetAuthProvider --> CancelTimers[取消所有定时器]
    CancelTimers --> CloseConnections[关闭WebSocket连接]
    
    CloseConnections --> HideLoadingIndicator[隐藏加载指示器]
    HideLoadingIndicator --> ShowLogoutSuccess[显示退出成功提示]
    
    ShowLogoutSuccess --> NavigateToLogin[导航到登录页面]
    NavigateToLogin --> ClearNavigationStack[清空导航栈]
    ClearNavigationStack --> ResetAppState[重置应用状态]
    
    ResetAppState --> End2([退出完成])
    
    style Start fill:#e1f5e1
    style End1 fill:#fff4e1
    style End2 fill:#ffe1e1
    style ProceedLocalLogout fill:#e1f0ff
```

---

## 八、异常处理流程

### 8.1 网络异常处理

```mermaid
flowchart TD
    Start([检测到网络异常]) --> ClassifyError{错误类型分类}
    
    ClassifyError -->|连接超时| TimeoutError[连接超时]
    ClassifyError -->|无网络连接| NoConnectionError[无网络连接]
    ClassifyError -->|服务器错误| ServerError[服务器错误]
    ClassifyError -->|请求被拒绝| RequestDenied[请求被拒绝]
    
    TimeoutError --> ShowTimeoutMsg[显示: 连接超时请重试]
    NoConnectionError --> ShowNoNetMsg[显示: 请检查网络连接]
    ServerError --> ShowServerMsg[显示: 服务器繁忙请稍后再试]
    RequestDenied --> ShowDeniedMsg[显示: 请求失败]
    
    ShowTimeoutMsg --> LogError[记录错误日志]
    ShowNoNetMsg --> LogError
    ShowServerMsg --> LogError
    ShowDeniedMsg --> LogError
    
    LogError --> ProvideRetry[提供重试选项]
    ProvideRetry --> UserChoice{用户选择}
    
    UserChoice -->|点击重试| RetryRequest[重试请求]
    UserChoice -->|点击取消| CancelRequest[取消请求]
    
    RetryRequest --> CheckRetryCount{检查重试次数}
    CheckRetryCount -->|<3次| ExecuteRetry[执行重试]
    CheckRetryCount -->|>=3次| ShowGiveUp[显示: 请稍后再试]
    
    ExecuteRetry --> End1([返回重试])
    ShowGiveUp --> End2([放弃请求])
    CancelRequest --> End2
    
    style Start fill:#ffe1e1
    style End1 fill:#fff4e1
    style End2 fill:#ffe1e1
```

### 8.2 验证码错误处理

```mermaid
flowchart TD
    Start([验证码验证失败]) --> GetErrorCode{获取错误代码}
    
    GetErrorCode -->|INVALID_CODE| CodeWrong[验证码错误]
    GetErrorCode -->|EXPIRED_CODE| CodeExpired[验证码已过期]
    GetErrorCode -->|CODE_NOT_FOUND| CodeNotFound[验证码不存在]
    GetErrorCode -->|TOO_MANY_ATTEMPTS| TooManyAttempts[尝试次数过多]
    
    CodeWrong --> GetRemainingAttempts[获取剩余尝试次数]
    GetRemainingAttempts --> ShowWrongMsg[显示: 验证码错误剩余X次机会]
    ShowWrongMsg --> ClearInput[清空输入框]
    ClearInput --> RefocusFirst[聚焦第一个输入框]
    
    CodeExpired --> ShowExpiredMsg[显示: 验证码已过期]
    ShowExpiredMsg --> ProvideResend[提供重新发送选项]
    
    CodeNotFound --> ShowNotFoundMsg[显示: 验证码无效]
    ShowNotFoundMsg --> ProvideResend
    
    TooManyAttempts --> LockInput[锁定输入框]
    LockInput --> ShowLockMsg[显示: 尝试次数过多请10分钟后再试]
    ShowLockMsg --> StartLockTimer[开始10分钟倒计时]
    StartLockTimer --> DisableResend[禁用重新发送]
    
    ProvideResend --> UserAction{用户操作}
    UserAction -->|点击重新发送| ResendCode[重新发送验证码]
    UserAction -->|点击返回| NavigateBack[返回登录页]
    
    ResendCode --> End1([重新发送流程])
    NavigateBack --> End2([返回上一页])
    RefocusFirst --> End3([继续输入])
    DisableResend --> End4([等待解锁])
    
    style Start fill:#ffe1e1
    style End1 fill:#fff4e1
    style End2 fill:#e1f0ff
    style End3 fill:#e1f5e1
    style End4 fill:#ffe1e1
```

---

## 九、完整用户旅程总览

```mermaid
flowchart TD
    Start([用户下载安装APP]) --> FirstOpen[首次打开APP]
    FirstOpen --> SplashScreen[显示启动画面]
    SplashScreen --> NoAuthDetected[检测到未登录]
    
    NoAuthDetected --> ShowLoginPage[显示登录页面]
    ShowLoginPage --> InputPhoneNumber[输入手机号]
    InputPhoneNumber --> AgreeTerms[同意用户协议]
    AgreeTerms --> SendSMS[发送验证码]
    
    SendSMS --> ReceiveSMS[收到短信验证码]
    ReceiveSMS --> InputCode[输入验证码]
    InputCode --> VerifySuccess[验证成功]
    
    VerifySuccess --> CheckNewUser{是否新用户?}
    CheckNewUser -->|是| CreateAccount[创建账号]
    CheckNewUser -->|否| LoadExistingAccount[加载现有账号]
    
    CreateAccount --> GuideProfileSetup[引导完善资料]
    GuideProfileSetup --> FillNickname[填写昵称]
    FillNickname --> SelectSkillLevel[选择网球水平]
    SelectSkillLevel --> UploadAvatar[上传头像可选]
    UploadAvatar --> ProfileComplete[资料完善完成]
    
    LoadExistingAccount --> WelcomeBack[欢迎回来]
    ProfileComplete --> FirstLogin[首次登录完成]
    WelcomeBack --> FirstLogin
    
    FirstLogin --> SavePhoneLocally[保存手机号到本地]
    SavePhoneLocally --> EnterApp[进入应用]
    
    EnterApp --> UseApp[使用应用功能]
    UseApp --> CloseApp[关闭应用]
    
    CloseApp --> NextOpen[再次打开APP]
    NextOpen --> ShowSplashAgain[显示启动画面]
    ShowSplashAgain --> CheckAuth[检查认证状态]
    
    CheckAuth --> TokenValid{Token有效?}
    TokenValid -->|是| DirectEnter[直接进入应用]
    TokenValid -->|否| ShowOneClickLogin[显示一键登录]
    
    ShowOneClickLogin --> DisplayMaskedPhone[显示脱敏手机号]
    DisplayMaskedPhone --> ClickOneClick[点击一键登录]
    ClickOneClick --> QuickVerify[快速验证]
    
    QuickVerify --> LoginSuccess[登录成功]
    LoginSuccess --> EnterAppAgain[进入应用]
    
    DirectEnter --> ContinueUse[继续使用]
    EnterAppAgain --> ContinueUse
    
    ContinueUse --> End([持续使用])
    
    style Start fill:#e1f5e1
    style End fill:#e1f0ff
    style CreateAccount fill:#fff4e1
    style QuickVerify fill:#e1f0ff
```

---

## 总结

本文档详细描述了基于手机号验证码的现代化登录系统的完整流程，包括：

1. **应用启动与认证检查**：Token验证和自动登录
2. **首次登录流程**：手机号输入、验证码发送、验证和注册
3. **验证码验证流程**：4位数字输入、自动提交、错误处理
4. **一键登录流程**：快速登录、Token刷新、自动验证
5. **国家代码选择**：列表展示、搜索、选择
6. **Token刷新机制**：自动刷新、过期处理
7. **退出登录流程**：本地清理、服务器端登出
8. **异常处理**：网络异常、验证码错误

每个流程图都清晰地展示了各个步骤、判断条件和可能的异常情况，为开发和测试提供了完整的参考。
