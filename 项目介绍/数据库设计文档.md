# Tennis-Frog æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> é¡¹ç›®åç§°ï¼šTennis-Frog ç½‘çƒç¤¾äº¤å¹³å°  
> æ•°æ®åº“ï¼šPostgreSQL  
> ç‰ˆæœ¬ï¼šv1.0  
> æ›´æ–°æ—¥æœŸï¼š2025-11-06

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
2. [ç”¨æˆ·è¡¨ï¼ˆusersï¼‰](#1-ç”¨æˆ·è¡¨users)
3. [çŸ­ä¿¡éªŒè¯ç è¡¨ï¼ˆsms_verification_codesï¼‰](#2-çŸ­ä¿¡éªŒè¯ç è¡¨sms_verification_codes)
4. [ç”¨æˆ·ä¼šè¯è¡¨ï¼ˆuser_sessionsï¼‰](#3-ç”¨æˆ·ä¼šè¯è¡¨user_sessions)
5. [ç™»å½•æ—¥å¿—è¡¨ï¼ˆlogin_logsï¼‰](#4-ç™»å½•æ—¥å¿—è¡¨login_logs)
5. [è¡¨å…³ç³»å›¾](#è¡¨å…³ç³»å›¾)
6. [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)
7. [æ•°æ®çº¦æŸ](#æ•°æ®çº¦æŸ)
8. [Flutteræ¨¡å‹æ˜ å°„](#flutteræ¨¡å‹æ˜ å°„)
9. [æ•°æ®å®‰å…¨è®¾è®¡](#æ•°æ®å®‰å…¨è®¾è®¡)

---

## æ•°æ®åº“æ¦‚è¿°

### æŠ€æœ¯é€‰å‹

- **æ•°æ®åº“ç±»å‹**ï¼šPostgreSQL 14+
- **å­—ç¬¦ç¼–ç **ï¼šUTF-8
- **æ—¶åŒº**ï¼šUTCï¼ˆå­˜å‚¨æ—¶ä½¿ç”¨UTCï¼Œæ˜¾ç¤ºæ—¶è½¬æ¢ä¸ºç”¨æˆ·æ—¶åŒºï¼‰
- **è¿æ¥æ± **ï¼šSQLAlchemyï¼ˆPythonï¼‰æˆ–ç±»ä¼¼ORM

### è®¾è®¡åŸåˆ™

1. **æ‰‹æœºå·ä¸ºä¸»**ï¼šä»¥æ‰‹æœºå·ä½œä¸ºä¸»è¦ç™»å½•å‡­è¯
2. **å®‰å…¨ä¼˜å…ˆ**ï¼šå®Œæ•´çš„éªŒè¯ç å’ŒTokenç®¡ç†æœºåˆ¶
3. **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™ç¬¬ä¸‰æ–¹ç™»å½•å­—æ®µ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå…³é”®å­—æ®µå»ºç«‹ç´¢å¼•
5. **æ•°æ®å®Œæ•´æ€§**ï¼šå¤–é”®çº¦æŸå’Œæ£€æŸ¥çº¦æŸ

---

## 1. ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

### è¡¨ç»“æ„

```sql
CREATE TABLE users (
    -- ========== åŸºç¡€ä¿¡æ¯ ==========
    id SERIAL PRIMARY KEY,
    phone VARCHAR(20) UNIQUE NOT NULL,           -- ä¸»è¦ç™»å½•å‡­è¯
    country_code VARCHAR(10) DEFAULT '+86',      -- å›½å®¶ä»£ç 
    username VARCHAR(50) UNIQUE,                  -- ç”¨æˆ·åï¼ˆå¯é€‰ï¼ŒåæœŸè¡¥å…¨ï¼‰
    
    -- ========== ä¸ªäººèµ„æ–™ ==========
    avatar VARCHAR(500),                         -- å¤´åƒURL
    nickname VARCHAR(100),                       -- æ˜µç§°
    bio TEXT,                                    -- ä¸ªäººç®€ä»‹
    gender VARCHAR(10),                          -- 'male', 'female', 'other', 'prefer_not_to_say'
    birth_date DATE,                             -- å‡ºç”Ÿæ—¥æœŸ
    
    -- ========== ç½‘çƒç›¸å…³ ==========
    skill_level VARCHAR(20) DEFAULT 'beginner',  -- æŠ€èƒ½ç­‰çº§
    -- å¯é€‰å€¼: 'beginner' (åˆçº§), 'intermediate' (ä¸­çº§), 'advanced' (é«˜çº§), 'professional' (ä¸“ä¸š)
    
    play_style VARCHAR(50),                      -- æ‰“æ³•é£æ ¼
    -- å¯é€‰å€¼: 'baseline' (åº•çº¿å‹), 'serve_and_volley' (å‘çƒä¸Šç½‘å‹), 'all_court' (å…¨åœºå‹)
    
    favorite_court VARCHAR(255),                 -- å¸¸å»çƒåœº
    racket_brand VARCHAR(100),                   -- çƒæ‹å“ç‰Œ
    
    -- ========== è´¦æˆ·çŠ¶æ€ ==========
    is_active BOOLEAN DEFAULT TRUE,              -- è´¦æˆ·æ˜¯å¦æ¿€æ´»
    is_phone_verified BOOLEAN DEFAULT TRUE,      -- æ‰‹æœºå·éªŒè¯çŠ¶æ€ï¼ˆéªŒè¯ç ç™»å½•åè‡ªåŠ¨ä¸ºtrueï¼‰
    is_premium BOOLEAN DEFAULT FALSE,            -- ä¼šå‘˜çŠ¶æ€
    is_profile_completed BOOLEAN DEFAULT FALSE,  -- èµ„æ–™æ˜¯å¦å®Œå–„
    
    -- ========== ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆæ‰©å±•ï¼‰ ==========
    wechat_openid VARCHAR(100) UNIQUE,           -- å¾®ä¿¡OpenID
    qq_openid VARCHAR(100) UNIQUE,               -- QQ OpenID
    apple_id VARCHAR(100) UNIQUE,                -- Apple ID
    
    -- ========== æ—¶é—´æˆ³ ==========
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,      -- æœ€åç™»å½•æ—¶é—´
    
    -- ========== æ•°æ®çº¦æŸ ==========
    CONSTRAINT users_phone_check CHECK (char_length(phone) >= 8),
    CONSTRAINT users_nickname_check CHECK (nickname IS NULL OR char_length(nickname) >= 2)
);
```

### å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | SERIAL | PRIMARY KEY | è‡ªå¢ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `phone` | VARCHAR(20) | UNIQUE, NOT NULL | - | æ‰‹æœºå·ï¼ˆä¸»è¦ç™»å½•å‡­è¯ï¼‰ |
| `country_code` | VARCHAR(10) | - | '+86' | å›½å®¶/åœ°åŒºä»£ç  |
| `username` | VARCHAR(50) | UNIQUE | NULL | ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰ |
| `avatar` | VARCHAR(500) | - | NULL | å¤´åƒURLï¼ˆOSSå­˜å‚¨ï¼‰ |
| `nickname` | VARCHAR(100) | - | NULL | æ˜µç§°ï¼ˆæ˜¾ç¤ºåç§°ï¼‰ |
| `bio` | TEXT | - | NULL | ä¸ªäººç®€ä»‹ |
| `gender` | VARCHAR(10) | - | NULL | æ€§åˆ«ï¼š'male'/'female'/'other' |
| `birth_date` | DATE | - | NULL | å‡ºç”Ÿæ—¥æœŸ |
| `skill_level` | VARCHAR(20) | - | 'beginner' | æŠ€èƒ½ç­‰çº§ |
| `play_style` | VARCHAR(50) | - | NULL | æ‰“æ³•é£æ ¼ |
| `favorite_court` | VARCHAR(255) | - | NULL | å¸¸å»çƒåœº |
| `racket_brand` | VARCHAR(100) | - | NULL | çƒæ‹å“ç‰Œ |
| `is_active` | BOOLEAN | - | TRUE | è´¦æˆ·æ˜¯å¦æ¿€æ´» |
| `is_phone_verified` | BOOLEAN | - | TRUE | æ‰‹æœºå·æ˜¯å¦å·²éªŒè¯ |
| `is_premium` | BOOLEAN | - | FALSE | æ˜¯å¦ä¼šå‘˜ |
| `is_profile_completed` | BOOLEAN | - | FALSE | èµ„æ–™æ˜¯å¦å®Œå–„ |
| `wechat_openid` | VARCHAR(100) | UNIQUE | NULL | å¾®ä¿¡OpenID |
| `qq_openid` | VARCHAR(100) | UNIQUE | NULL | QQ OpenID |
| `apple_id` | VARCHAR(100) | UNIQUE | NULL | Apple ID |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |
| `last_login_at` | TIMESTAMP | - | NULL | æœ€åç™»å½•æ—¶é—´ |

### ç´¢å¼•è®¾è®¡

```sql
-- æ‰‹æœºå·ç´¢å¼•ï¼ˆæœ€å¸¸ç”¨æŸ¥è¯¢ï¼‰
CREATE INDEX idx_users_phone ON users(phone);

-- å›½å®¶ä»£ç ç´¢å¼•ï¼ˆç”¨äºç»Ÿè®¡å’Œç­›é€‰ï¼‰
CREATE INDEX idx_users_country_code ON users(country_code);

-- å¾®ä¿¡OpenIDç´¢å¼•ï¼ˆç¬¬ä¸‰æ–¹ç™»å½•ï¼‰
CREATE INDEX idx_users_wechat_openid ON users(wechat_openid) WHERE wechat_openid IS NOT NULL;

-- åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼ˆç”¨äºæ’åºå’Œç»Ÿè®¡ï¼‰
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- ç”¨æˆ·åç´¢å¼•ï¼ˆå·²é€šè¿‡UNIQUEçº¦æŸè‡ªåŠ¨åˆ›å»ºï¼‰
-- CREATE INDEX idx_users_username ON users(username);
```

### æ•°æ®çº¦æŸ

```sql
-- æ‰‹æœºå·é•¿åº¦æ£€æŸ¥ï¼ˆè‡³å°‘8ä½ï¼‰
CONSTRAINT users_phone_check CHECK (char_length(phone) >= 8)

-- æ˜µç§°é•¿åº¦æ£€æŸ¥ï¼ˆå¦‚æœæä¾›ï¼Œè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰
CONSTRAINT users_nickname_check CHECK (nickname IS NULL OR char_length(nickname) >= 2)
```

### è§¦å‘å™¨ï¼ˆè‡ªåŠ¨æ›´æ–°updated_atï¼‰

```sql
-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER update_users_updated_at 
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## 2. çŸ­ä¿¡éªŒè¯ç è¡¨ï¼ˆsms_verification_codesï¼‰

### è¡¨ç»“æ„

```sql
CREATE TABLE sms_verification_codes (
    -- ========== åŸºç¡€ä¿¡æ¯ ==========
    id SERIAL PRIMARY KEY,
    phone VARCHAR(20) NOT NULL,                  -- æ‰‹æœºå·
    country_code VARCHAR(10) DEFAULT '+86',      -- å›½å®¶ä»£ç 
    code VARCHAR(6) NOT NULL,                    -- 4-6ä½æ•°å­—éªŒè¯ç 
    
    -- ========== éªŒè¯ç çŠ¶æ€ ==========
    is_used BOOLEAN DEFAULT FALSE,              -- æ˜¯å¦å·²ä½¿ç”¨
    is_expired BOOLEAN DEFAULT FALSE,           -- æ˜¯å¦è¿‡æœŸ
    
    -- ========== æ—¶é—´æ§åˆ¶ ==========
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL, -- è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸5-10åˆ†é’Ÿï¼‰
    used_at TIMESTAMP WITH TIME ZONE,            -- ä½¿ç”¨æ—¶é—´
    
    -- ========== å®‰å…¨æ§åˆ¶ ==========
    ip_address VARCHAR(45),                      -- IPåœ°å€ï¼ˆæ”¯æŒIPv6ï¼‰
    device_info TEXT,                             -- è®¾å¤‡ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
    attempt_count INTEGER DEFAULT 0              -- å°è¯•æ¬¡æ•°ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰
);
```

### å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | SERIAL | PRIMARY KEY | è‡ªå¢ | éªŒè¯ç è®°å½•ID |
| `phone` | VARCHAR(20) | NOT NULL | - | æ‰‹æœºå· |
| `country_code` | VARCHAR(10) | - | '+86' | å›½å®¶ä»£ç  |
| `code` | VARCHAR(6) | NOT NULL | - | éªŒè¯ç ï¼ˆ4-6ä½æ•°å­—ï¼‰ |
| `is_used` | BOOLEAN | - | FALSE | æ˜¯å¦å·²ä½¿ç”¨ |
| `is_expired` | BOOLEAN | - | FALSE | æ˜¯å¦è¿‡æœŸ |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `expires_at` | TIMESTAMP | NOT NULL | - | è¿‡æœŸæ—¶é—´ |
| `used_at` | TIMESTAMP | - | NULL | ä½¿ç”¨æ—¶é—´ |
| `ip_address` | VARCHAR(45) | - | NULL | IPåœ°å€ |
| `device_info` | TEXT | - | NULL | è®¾å¤‡ä¿¡æ¯ï¼ˆJSONï¼‰ |
| `attempt_count` | INTEGER | - | 0 | å°è¯•æ¬¡æ•° |

### ç´¢å¼•è®¾è®¡

```sql
-- æ‰‹æœºå·å’Œåˆ›å»ºæ—¶é—´è”åˆç´¢å¼•ï¼ˆæŸ¥è¯¢æœ€æ–°éªŒè¯ç ï¼‰
CREATE INDEX idx_sms_phone_created ON sms_verification_codes(phone, created_at DESC);

-- è¿‡æœŸæ—¶é—´ç´¢å¼•ï¼ˆç”¨äºæ¸…ç†è¿‡æœŸæ•°æ®ï¼‰
CREATE INDEX idx_sms_expires ON sms_verification_codes(expires_at);

-- æ¸…ç†ç´¢å¼•ï¼ˆç”¨äºå®šæ—¶ä»»åŠ¡æ¸…ç†å·²ä½¿ç”¨æˆ–è¿‡æœŸçš„éªŒè¯ç ï¼‰
CREATE INDEX idx_sms_cleanup ON sms_verification_codes(created_at) 
WHERE is_expired = TRUE OR is_used = TRUE;
```

### æ•°æ®çº¦æŸ

```sql
-- éªŒè¯ç æ ¼å¼æ£€æŸ¥ï¼ˆ4-6ä½æ•°å­—ï¼‰
CONSTRAINT sms_codes_code_check CHECK (code ~ '^\d{4,6}$')
```

### ä¸šåŠ¡è§„åˆ™

1. **éªŒè¯ç æœ‰æ•ˆæœŸ**ï¼šé€šå¸¸5-10åˆ†é’Ÿ
2. **éªŒè¯ç é•¿åº¦**ï¼š4ä½ï¼ˆçŸ­ä¿¡éªŒè¯ç ï¼‰æˆ–6ä½ï¼ˆé‚®ç®±éªŒè¯ç ï¼‰
3. **ä½¿ç”¨é™åˆ¶**ï¼šæ¯ä¸ªéªŒè¯ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
4. **é¢‘ç‡é™åˆ¶**ï¼šåŒä¸€æ‰‹æœºå·60ç§’å†…åªèƒ½å‘é€ä¸€æ¬¡
5. **å°è¯•æ¬¡æ•°**ï¼šæœ€å¤šå°è¯•3æ¬¡ï¼Œè¶…è¿‡åé”å®š10åˆ†é’Ÿ
6. **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå’Œå·²ä½¿ç”¨çš„éªŒè¯ç 

---

## 3. ç”¨æˆ·ä¼šè¯è¡¨ï¼ˆuser_sessionsï¼‰

### è¡¨ç»“æ„

```sql
CREATE TABLE user_sessions (
    -- ========== åŸºç¡€ä¿¡æ¯ ==========
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ========== Tokenä¿¡æ¯ ==========
    access_token VARCHAR(500) UNIQUE NOT NULL,   -- è®¿é—®ä»¤ç‰Œï¼ˆJWTï¼‰
    refresh_token VARCHAR(500) UNIQUE NOT NULL,  -- åˆ·æ–°ä»¤ç‰Œï¼ˆJWTï¼‰
    token_type VARCHAR(20) DEFAULT 'Bearer',      -- Tokenç±»å‹
    
    -- ========== è®¾å¤‡ä¿¡æ¯ ==========
    device_name VARCHAR(100),                    -- è®¾å¤‡åç§°ï¼šiPhone 13, Xiaomi 11 ç­‰
    device_type VARCHAR(50),                      -- è®¾å¤‡ç±»å‹ï¼šiOS, Android, Web
    device_id VARCHAR(255),                       -- è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰
    
    -- ========== ç™»å½•ä¿¡æ¯ ==========
    ip_address VARCHAR(45),                      -- IPåœ°å€ï¼ˆæ”¯æŒIPv6ï¼‰
    user_agent TEXT,                             -- ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²
    location VARCHAR(255),                       -- ç™»å½•åœ°ç‚¹ï¼ˆå¯é€‰ï¼Œé€šè¿‡IPè§£æï¼‰
    
    -- ========== çŠ¶æ€æ§åˆ¶ ==========
    is_active BOOLEAN DEFAULT TRUE,             -- ä¼šè¯æ˜¯å¦æ´»è·ƒ
    
    -- ========== æ—¶é—´æˆ³ ==========
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_active_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL -- Tokenè¿‡æœŸæ—¶é—´
);
```

### å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | SERIAL | PRIMARY KEY | è‡ªå¢ | ä¼šè¯ID |
| `user_id` | INTEGER | NOT NULL, FOREIGN KEY | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| `access_token` | VARCHAR(500) | UNIQUE, NOT NULL | - | è®¿é—®ä»¤ç‰Œ |
| `refresh_token` | VARCHAR(500) | UNIQUE, NOT NULL | - | åˆ·æ–°ä»¤ç‰Œ |
| `token_type` | VARCHAR(20) | - | 'Bearer' | Tokenç±»å‹ |
| `device_name` | VARCHAR(100) | - | NULL | è®¾å¤‡åç§° |
| `device_type` | VARCHAR(50) | - | NULL | è®¾å¤‡ç±»å‹ |
| `device_id` | VARCHAR(255) | - | NULL | è®¾å¤‡å”¯ä¸€æ ‡è¯† |
| `ip_address` | VARCHAR(45) | - | NULL | IPåœ°å€ |
| `user_agent` | TEXT | - | NULL | ç”¨æˆ·ä»£ç† |
| `location` | VARCHAR(255) | - | NULL | ç™»å½•åœ°ç‚¹ |
| `is_active` | BOOLEAN | - | TRUE | æ˜¯å¦æ´»è·ƒ |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `last_active_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | æœ€åæ´»è·ƒæ—¶é—´ |
| `expires_at` | TIMESTAMP | NOT NULL | - | è¿‡æœŸæ—¶é—´ |

### ç´¢å¼•è®¾è®¡

```sql
-- ç”¨æˆ·IDç´¢å¼•ï¼ˆæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯ï¼‰
CREATE INDEX idx_sessions_user ON user_sessions(user_id);

-- è®¿é—®ä»¤ç‰Œç´¢å¼•ï¼ˆéªŒè¯Tokenï¼‰
CREATE INDEX idx_sessions_access_token ON user_sessions(access_token);

-- åˆ·æ–°ä»¤ç‰Œç´¢å¼•ï¼ˆåˆ·æ–°Tokenï¼‰
CREATE INDEX idx_sessions_refresh_token ON user_sessions(refresh_token);

-- æ´»è·ƒä¼šè¯ç´¢å¼•ï¼ˆæŸ¥è¯¢ç”¨æˆ·æ´»è·ƒä¼šè¯ï¼‰
CREATE INDEX idx_sessions_active ON user_sessions(user_id, is_active) 
WHERE is_active = TRUE;
```

### å¤–é”®çº¦æŸ

```sql
-- ç”¨æˆ·IDå¤–é”®ï¼ˆçº§è”åˆ é™¤ï¼‰
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

### ä¸šåŠ¡è§„åˆ™

1. **Tokenæœ‰æ•ˆæœŸ**ï¼š
   - Access Tokenï¼š2å°æ—¶
   - Refresh Tokenï¼š30å¤©

2. **å¤šè®¾å¤‡ç™»å½•**ï¼šæ”¯æŒåŒä¸€ç”¨æˆ·å¤šä¸ªè®¾å¤‡åŒæ—¶ç™»å½•

3. **ä¼šè¯ç®¡ç†**ï¼š
   - ç”¨æˆ·ç™»å‡ºæ—¶è®¾ç½® `is_active = FALSE`
   - å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
   - æ”¯æŒå¼ºåˆ¶ä¸‹çº¿ï¼ˆè®¾ç½®æ‰€æœ‰ä¼šè¯ä¸ºä¸æ´»è·ƒï¼‰

4. **å®‰å…¨æ§åˆ¶**ï¼š
   - è®°å½•è®¾å¤‡ä¿¡æ¯ï¼Œæ”¯æŒå¼‚å¸¸æ£€æµ‹
   - è®°å½•IPåœ°å€ï¼Œæ”¯æŒåœ°ç†ä½ç½®åˆ†æ
   - æ”¯æŒè®¾å¤‡ç»‘å®šï¼Œé˜²æ­¢è´¦å·è¢«ç›—ç”¨

---

## 4. ç™»å½•æ—¥å¿—è¡¨ï¼ˆlogin_logsï¼‰

### è¡¨ç»“æ„

```sql
CREATE TABLE login_logs (
    -- ========== åŸºç¡€ä¿¡æ¯ ==========
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    phone VARCHAR(20) NOT NULL,                  -- æ‰‹æœºå·ï¼ˆå³ä½¿ç”¨æˆ·è¢«åˆ é™¤ä¹Ÿä¿ç•™ï¼‰
    
    -- ========== ç™»å½•æ–¹å¼ ==========
    login_method VARCHAR(50) NOT NULL,          -- ç™»å½•æ–¹å¼
    -- å¯é€‰å€¼: 'sms_code', 'one_click', 'wechat', 'qq', 'apple'
    
    login_status VARCHAR(20) NOT NULL,         -- ç™»å½•çŠ¶æ€
    -- å¯é€‰å€¼: 'success', 'failed', 'blocked'
    
    -- ========== å¤±è´¥åŸå›  ==========
    failure_reason VARCHAR(255),                -- å¤±è´¥åŸå› 
    -- å¯é€‰å€¼: 'invalid_code', 'expired_code', 'account_blocked', 'rate_limit' ç­‰
    
    -- ========== è®¾å¤‡å’Œä½ç½®ä¿¡æ¯ ==========
    ip_address VARCHAR(45),                    -- IPåœ°å€
    device_type VARCHAR(50),                    -- è®¾å¤‡ç±»å‹
    device_name VARCHAR(100),                  -- è®¾å¤‡åç§°
    user_agent TEXT,                            -- ç”¨æˆ·ä»£ç†
    location VARCHAR(255),                     -- ç™»å½•åœ°ç‚¹
    
    -- ========== æ—¶é—´æˆ³ ==========
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | SERIAL | PRIMARY KEY | è‡ªå¢ | æ—¥å¿—ID |
| `user_id` | INTEGER | FOREIGN KEY | NULL | ç”¨æˆ·IDï¼ˆå¯ä¸ºç©ºï¼‰ |
| `phone` | VARCHAR(20) | NOT NULL | - | æ‰‹æœºå· |
| `login_method` | VARCHAR(50) | NOT NULL | - | ç™»å½•æ–¹å¼ |
| `login_status` | VARCHAR(20) | NOT NULL | - | ç™»å½•çŠ¶æ€ |
| `failure_reason` | VARCHAR(255) | - | NULL | å¤±è´¥åŸå›  |
| `ip_address` | VARCHAR(45) | - | NULL | IPåœ°å€ |
| `device_type` | VARCHAR(50) | - | NULL | è®¾å¤‡ç±»å‹ |
| `device_name` | VARCHAR(100) | - | NULL | è®¾å¤‡åç§° |
| `user_agent` | TEXT | - | NULL | ç”¨æˆ·ä»£ç† |
| `location` | VARCHAR(255) | - | NULL | ç™»å½•åœ°ç‚¹ |
| `created_at` | TIMESTAMP | - | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

### ç´¢å¼•è®¾è®¡

```sql
-- ç”¨æˆ·IDå’Œæ—¶é—´ç´¢å¼•ï¼ˆæŸ¥è¯¢ç”¨æˆ·ç™»å½•å†å²ï¼‰
CREATE INDEX idx_login_logs_user ON login_logs(user_id, created_at DESC) 
WHERE user_id IS NOT NULL;

-- æ‰‹æœºå·å’Œæ—¶é—´ç´¢å¼•ï¼ˆæŸ¥è¯¢æ‰‹æœºå·ç™»å½•å†å²ï¼‰
CREATE INDEX idx_login_logs_phone ON login_logs(phone, created_at DESC);

-- ç™»å½•çŠ¶æ€å’Œæ—¶é—´ç´¢å¼•ï¼ˆç»Ÿè®¡å’Œåˆ†æï¼‰
CREATE INDEX idx_login_logs_status ON login_logs(login_status, created_at DESC);

-- IPåœ°å€ç´¢å¼•ï¼ˆå¼‚å¸¸æ£€æµ‹ï¼‰
CREATE INDEX idx_login_logs_ip ON login_logs(ip_address, created_at DESC);
```

### å¤–é”®çº¦æŸ

```sql
-- ç”¨æˆ·IDå¤–é”®ï¼ˆç”¨æˆ·åˆ é™¤æ—¶è®¾ç½®ä¸ºNULLï¼Œä¿ç•™æ—¥å¿—ï¼‰
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
```

### ä¸šåŠ¡è§„åˆ™

1. **æ—¥å¿—ä¿ç•™**ï¼š
   - ç”¨æˆ·åˆ é™¤æ—¶ä¿ç•™ç™»å½•æ—¥å¿—ï¼ˆuser_idè®¾ä¸ºNULLï¼‰
   - å®šæœŸå½’æ¡£æ—§æ—¥å¿—ï¼ˆå¦‚6ä¸ªæœˆå‰çš„æ—¥å¿—ï¼‰

2. **ç™»å½•æ–¹å¼æšä¸¾**ï¼š
   - `sms_code`ï¼šçŸ­ä¿¡éªŒè¯ç ç™»å½•
   - `one_click`ï¼šä¸€é”®ç™»å½•
   - `wechat`ï¼šå¾®ä¿¡ç™»å½•
   - `qq`ï¼šQQç™»å½•
   - `apple`ï¼šApple IDç™»å½•

3. **ç™»å½•çŠ¶æ€æšä¸¾**ï¼š
   - `success`ï¼šç™»å½•æˆåŠŸ
   - `failed`ï¼šç™»å½•å¤±è´¥
   - `blocked`ï¼šè´¦å·è¢«é”å®š

4. **å¤±è´¥åŸå› æšä¸¾**ï¼š
   - `invalid_code`ï¼šéªŒè¯ç é”™è¯¯
   - `expired_code`ï¼šéªŒè¯ç è¿‡æœŸ
   - `account_blocked`ï¼šè´¦å·è¢«é”å®š
   - `rate_limit`ï¼šè¯·æ±‚é¢‘ç‡è¿‡é«˜
   - `network_error`ï¼šç½‘ç»œé”™è¯¯
   - `unknown`ï¼šæœªçŸ¥é”™è¯¯

---

## è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ phone (UNIQUE)  â”‚      â”‚
â”‚ country_code    â”‚      â”‚
â”‚ username        â”‚      â”‚
â”‚ ...             â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                         â”‚
                         â”‚ ON DELETE CASCADE
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚      user_sessions             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                        â”‚
â”‚ user_id (FK â†’ users.id)        â”‚
â”‚ access_token (UNIQUE)          â”‚
â”‚ refresh_token (UNIQUE)         â”‚
â”‚ device_name                    â”‚
â”‚ ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ phone (UNIQUE)  â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                         â”‚ ON DELETE SET NULL
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚      login_logs                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                        â”‚
â”‚ user_id (FK â†’ users.id)        â”‚
â”‚ phone                          â”‚
â”‚ login_method                   â”‚
â”‚ login_status                   â”‚
â”‚ ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sms_verification_codes     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                     â”‚
â”‚ phone                       â”‚
â”‚ country_code                â”‚
â”‚ code                        â”‚
â”‚ is_used                     â”‚
â”‚ expires_at                  â”‚
â”‚ ...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ï¼ˆç‹¬ç«‹è¡¨ï¼Œæ— å¤–é”®å…³ç³»ï¼‰
```

---

## ç´¢å¼•è®¾è®¡æ€»ç»“

### ä¸»è¦ç´¢å¼•

| è¡¨å | ç´¢å¼•å | å­—æ®µ | ç”¨é€” |
|------|--------|------|------|
| `users` | `idx_users_phone` | `phone` | æ‰‹æœºå·æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰ |
| `users` | `idx_users_country_code` | `country_code` | æŒ‰å›½å®¶ç»Ÿè®¡ |
| `users` | `idx_users_created_at` | `created_at DESC` | æŒ‰æ—¶é—´æ’åº |
| `sms_verification_codes` | `idx_sms_phone_created` | `phone, created_at DESC` | æŸ¥è¯¢æœ€æ–°éªŒè¯ç  |
| `sms_verification_codes` | `idx_sms_expires` | `expires_at` | æ¸…ç†è¿‡æœŸéªŒè¯ç  |
| `user_sessions` | `idx_sessions_user` | `user_id` | æŸ¥è¯¢ç”¨æˆ·ä¼šè¯ |
| `user_sessions` | `idx_sessions_access_token` | `access_token` | éªŒè¯Token |
| `user_sessions` | `idx_sessions_refresh_token` | `refresh_token` | åˆ·æ–°Token |
| `login_logs` | `idx_login_logs_user` | `user_id, created_at DESC` | ç”¨æˆ·ç™»å½•å†å² |
| `login_logs` | `idx_login_logs_phone` | `phone, created_at DESC` | æ‰‹æœºå·ç™»å½•å†å² |

### éƒ¨åˆ†ç´¢å¼•ï¼ˆPartial Indexï¼‰

```sql
-- åªç´¢å¼•æ´»è·ƒä¼šè¯
CREATE INDEX idx_sessions_active ON user_sessions(user_id, is_active) 
WHERE is_active = TRUE;

-- åªç´¢å¼•éœ€è¦æ¸…ç†çš„éªŒè¯ç 
CREATE INDEX idx_sms_cleanup ON sms_verification_codes(created_at) 
WHERE is_expired = TRUE OR is_used = TRUE;
```

---

## æ•°æ®çº¦æŸæ€»ç»“

### æ£€æŸ¥çº¦æŸï¼ˆCHECK Constraintsï¼‰

```sql
-- ç”¨æˆ·è¡¨
CONSTRAINT users_phone_check CHECK (char_length(phone) >= 8)
CONSTRAINT users_nickname_check CHECK (nickname IS NULL OR char_length(nickname) >= 2)

-- éªŒè¯ç è¡¨
CONSTRAINT sms_codes_code_check CHECK (code ~ '^\d{4,6}$')
```

### å”¯ä¸€çº¦æŸï¼ˆUNIQUE Constraintsï¼‰

```sql
-- ç”¨æˆ·è¡¨
phone UNIQUE
username UNIQUE
wechat_openid UNIQUE
qq_openid UNIQUE
apple_id UNIQUE

-- ä¼šè¯è¡¨
access_token UNIQUE
refresh_token UNIQUE
```

### å¤–é”®çº¦æŸï¼ˆFOREIGN KEY Constraintsï¼‰

```sql
-- ä¼šè¯è¡¨ â†’ ç”¨æˆ·è¡¨ï¼ˆçº§è”åˆ é™¤ï¼‰
user_sessions.user_id â†’ users.id ON DELETE CASCADE

-- ç™»å½•æ—¥å¿—è¡¨ â†’ ç”¨æˆ·è¡¨ï¼ˆè®¾ç½®ä¸ºNULLï¼‰
login_logs.user_id â†’ users.id ON DELETE SET NULL
```

---

## Flutteræ¨¡å‹æ˜ å°„

### Useræ¨¡å‹ï¼ˆlib/models/user.dartï¼‰

```dart
@JsonSerializable()
class User {
  final int id;                                    // users.id
  final String phone;                              // users.phone
  @JsonKey(name: 'country_code')
  final String countryCode;                         // users.country_code
  final String? username;                          // users.username
  final String? avatar;                            // users.avatar
  final String? nickname;                          // users.nickname
  final String? bio;                                // users.bio
  final Gender? gender;                            // users.gender
  @JsonKey(name: 'birth_date')
  final String? birthDate;                         // users.birth_date
  @JsonKey(name: 'skill_level')
  final SkillLevel skillLevel;                     // users.skill_level
  @JsonKey(name: 'play_style')
  final PlayStyle? playStyle;                      // users.play_style
  @JsonKey(name: 'favorite_court')
  final String? favoriteCourt;                     // users.favorite_court
  @JsonKey(name: 'racket_brand')
  final String? racketBrand;                      // users.racket_brand
  @JsonKey(name: 'is_active')
  final bool isActive;                            // users.is_active
  @JsonKey(name: 'is_phone_verified')
  final bool isPhoneVerified;                     // users.is_phone_verified
  @JsonKey(name: 'is_premium')
  final bool isPremium;                           // users.is_premium
  @JsonKey(name: 'is_profile_completed')
  final bool isProfileCompleted;                  // users.is_profile_completed
  @JsonKey(name: 'created_at')
  final String createdAt;                         // users.created_at
  @JsonKey(name: 'last_login_at')
  final String? lastLoginAt;                      // users.last_login_at
}
```

### Tokenæ¨¡å‹ï¼ˆlib/models/token.dartï¼‰

```dart
@JsonSerializable()
class TokenResponse {
  @JsonKey(name: 'access_token')
  final String accessToken;                       // user_sessions.access_token
  @JsonKey(name: 'refresh_token')
  final String? refreshToken;                     // user_sessions.refresh_token
  @JsonKey(name: 'token_type')
  final String tokenType;                         // user_sessions.token_type
  @JsonKey(name: 'expires_in')
  final int expiresIn;                            // è®¡ç®—å¾—å‡ºï¼ˆexpires_at - nowï¼‰
}
```

### æšä¸¾ç±»å‹æ˜ å°„

```dart
// æŠ€èƒ½ç­‰çº§
enum SkillLevel {
  @JsonValue('beginner')
  beginner,        // users.skill_level = 'beginner'
  @JsonValue('intermediate')
  intermediate,    // users.skill_level = 'intermediate'
  @JsonValue('advanced')
  advanced,       // users.skill_level = 'advanced'
  @JsonValue('professional')
  professional    // users.skill_level = 'professional'
}

// æ€§åˆ«
enum Gender {
  @JsonValue('male')
  male,           // users.gender = 'male'
  @JsonValue('female')
  female,         // users.gender = 'female'
  @JsonValue('other')
  other           // users.gender = 'other'
}

// æ‰“æ³•é£æ ¼
enum PlayStyle {
  @JsonValue('baseline')
  baseline,       // users.play_style = 'baseline'
  @JsonValue('serve_and_volley')
  serveAndVolley, // users.play_style = 'serve_and_volley'
  @JsonValue('all_court')
  allCourt        // users.play_style = 'all_court'
}
```

---

## æ•°æ®å®‰å…¨è®¾è®¡

### 1. éªŒè¯ç å®‰å…¨æœºåˆ¶

#### æ—¶é—´æ§åˆ¶
- **æœ‰æ•ˆæœŸ**ï¼š5-10åˆ†é’Ÿ
- **å‘é€é¢‘ç‡**ï¼šåŒä¸€æ‰‹æœºå·60ç§’å†…åªèƒ½å‘é€ä¸€æ¬¡
- **å°è¯•æ¬¡æ•°**ï¼šæœ€å¤š3æ¬¡ï¼Œè¶…è¿‡åé”å®š10åˆ†é’Ÿ

#### çŠ¶æ€ç®¡ç†
- `is_used`ï¼šæ ‡è®°éªŒè¯ç æ˜¯å¦å·²ä½¿ç”¨
- `is_expired`ï¼šæ ‡è®°éªŒè¯ç æ˜¯å¦è¿‡æœŸ
- `attempt_count`ï¼šè®°å½•å°è¯•æ¬¡æ•°

#### è‡ªåŠ¨æ¸…ç†
```sql
-- å®šæœŸæ¸…ç†è¿‡æœŸå’Œå·²ä½¿ç”¨çš„éªŒè¯ç ï¼ˆé€šè¿‡å®šæ—¶ä»»åŠ¡ï¼‰
DELETE FROM sms_verification_codes 
WHERE (is_expired = TRUE OR is_used = TRUE) 
  AND created_at < NOW() - INTERVAL '1 day';
```

### 2. Tokenå®‰å…¨æœºåˆ¶

#### Tokenç±»å‹
- **Access Token**ï¼šçŸ­æœŸä»¤ç‰Œï¼ˆ2å°æ—¶ï¼‰ï¼Œç”¨äºAPIè¯·æ±‚
- **Refresh Token**ï¼šé•¿æœŸä»¤ç‰Œï¼ˆ30å¤©ï¼‰ï¼Œç”¨äºåˆ·æ–°Access Token

#### å®‰å…¨æªæ–½
- JWTæ ‡å‡†æ ¼å¼ï¼ŒåŒ…å«ç”¨æˆ·IDã€è¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯
- è®°å½•è®¾å¤‡ä¿¡æ¯ï¼Œæ”¯æŒå¼‚å¸¸æ£€æµ‹
- æ”¯æŒå¤šè®¾å¤‡ç™»å½•ï¼Œä½†å¯ä»¥å¼ºåˆ¶ä¸‹çº¿
- Tokenè¿‡æœŸåè‡ªåŠ¨åˆ·æ–°

#### ä¼šè¯ç®¡ç†
```sql
-- ç”¨æˆ·ç™»å‡ºæ—¶è®¾ç½®ä¼šè¯ä¸ºä¸æ´»è·ƒ
UPDATE user_sessions 
SET is_active = FALSE 
WHERE user_id = ? AND device_id = ?;

-- å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
DELETE FROM user_sessions 
WHERE expires_at < NOW() 
  AND is_active = FALSE;
```

### 3. ç™»å½•æ—¥å¿—å®‰å…¨

#### è®°å½•å†…å®¹
- æ‰€æœ‰ç™»å½•å°è¯•ï¼ˆæˆåŠŸå’Œå¤±è´¥ï¼‰
- è®¾å¤‡ä¿¡æ¯ã€IPåœ°å€ã€åœ°ç†ä½ç½®
- å¤±è´¥åŸå› åˆ†æ

#### å¼‚å¸¸æ£€æµ‹
- æ£€æµ‹å¼‚å¸¸IPåœ°å€
- æ£€æµ‹å¼‚å¸¸è®¾å¤‡
- æ£€æµ‹é¢‘ç¹å¤±è´¥ç™»å½•
- æ£€æµ‹åœ°ç†ä½ç½®å¼‚å¸¸

#### æ—¥å¿—ä¿ç•™
- ç”¨æˆ·åˆ é™¤æ—¶ä¿ç•™æ—¥å¿—ï¼ˆuser_idè®¾ä¸ºNULLï¼‰
- å®šæœŸå½’æ¡£æ—§æ—¥å¿—ï¼ˆ6ä¸ªæœˆå‰çš„æ—¥å¿—ï¼‰

---

## æ•°æ®ç»´æŠ¤

### å®šæ—¶ä»»åŠ¡

#### 1. æ¸…ç†è¿‡æœŸéªŒè¯ç 
```sql
-- æ¯å¤©æ‰§è¡Œä¸€æ¬¡
DELETE FROM sms_verification_codes 
WHERE (is_expired = TRUE OR is_used = TRUE) 
  AND created_at < NOW() - INTERVAL '1 day';
```

#### 2. æ¸…ç†è¿‡æœŸä¼šè¯
```sql
-- æ¯å¤©æ‰§è¡Œä¸€æ¬¡
DELETE FROM user_sessions 
WHERE expires_at < NOW() 
  AND is_active = FALSE;
```

#### 3. å½’æ¡£ç™»å½•æ—¥å¿—
```sql
-- æ¯æœˆæ‰§è¡Œä¸€æ¬¡ï¼Œå½’æ¡£6ä¸ªæœˆå‰çš„æ—¥å¿—
-- å¯ä»¥ç§»åŠ¨åˆ°å½’æ¡£è¡¨æˆ–å¯¼å‡ºåˆ°æ–‡ä»¶
```

### æ•°æ®å¤‡ä»½

#### å¤‡ä»½ç­–ç•¥
- **å…¨é‡å¤‡ä»½**ï¼šæ¯å¤©å‡Œæ™¨æ‰§è¡Œ
- **å¢é‡å¤‡ä»½**ï¼šæ¯å°æ—¶æ‰§è¡Œ
- **å¤‡ä»½ä¿ç•™**ï¼šä¿ç•™30å¤©

#### å¤‡ä»½å†…å®¹
- ç”¨æˆ·è¡¨ï¼ˆusersï¼‰
- ä¼šè¯è¡¨ï¼ˆuser_sessionsï¼‰
- ç™»å½•æ—¥å¿—è¡¨ï¼ˆlogin_logsï¼‰
- éªŒè¯ç è¡¨ï¼ˆsms_verification_codesï¼‰ä¸éœ€è¦å¤‡ä»½ï¼ˆä¸´æ—¶æ•°æ®ï¼‰

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
- é¿å…å…¨è¡¨æ‰«æ
- ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’

### 2. è¿æ¥æ± é…ç½®
- æœ€å¤§è¿æ¥æ•°ï¼š20-50
- è¿æ¥è¶…æ—¶ï¼š30ç§’
- ç©ºé—²è¿æ¥å›æ”¶ï¼š10åˆ†é’Ÿ

### 3. åˆ†åŒºè¡¨ï¼ˆå¯é€‰ï¼‰
- ç™»å½•æ—¥å¿—è¡¨å¯ä»¥æŒ‰æ—¶é—´åˆ†åŒº
- æ¯æœˆä¸€ä¸ªåˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

### 4. è¯»å†™åˆ†ç¦»ï¼ˆå¯é€‰ï¼‰
- ä¸»åº“ï¼šå†™æ“ä½œ
- ä»åº“ï¼šè¯»æ“ä½œ
- æé«˜å¹¶å‘æ€§èƒ½

---

## æ‰©å±•æ€§è®¾è®¡

### é¢„ç•™å­—æ®µ
- ç¬¬ä¸‰æ–¹ç™»å½•å­—æ®µï¼ˆwechat_openid, qq_openid, apple_idï¼‰
- ä¼šå‘˜ç³»ç»Ÿå­—æ®µï¼ˆis_premiumï¼‰
- ç”¨æˆ·ç­‰çº§å­—æ®µï¼ˆå¯æ‰©å±•ï¼‰

### æœªæ¥æ‰©å±•
1. **ç”¨æˆ·å…³ç³»è¡¨**ï¼šå…³æ³¨ã€ç²‰ä¸ã€å¥½å‹
2. **åŠ¨æ€è¡¨**ï¼šç”¨æˆ·å‘å¸ƒçš„åŠ¨æ€
3. **çº¦çƒæ´»åŠ¨è¡¨**ï¼šçº¦çƒæ´»åŠ¨ä¿¡æ¯
4. **æ¶ˆæ¯è¡¨**ï¼šç§ä¿¡ã€é€šçŸ¥
5. **è¯„è®ºè¡¨**ï¼šåŠ¨æ€è¯„è®º
6. **ç‚¹èµè¡¨**ï¼šåŠ¨æ€ç‚¹èµ

---

## æ€»ç»“

### è®¾è®¡ç‰¹ç‚¹

âœ… **æ‰‹æœºå·ä¸ºä¸»**ï¼šä»¥æ‰‹æœºå·ä½œä¸ºä¸»è¦ç™»å½•å‡­è¯  
âœ… **å®‰å…¨ä¼˜å…ˆ**ï¼šå®Œæ•´çš„éªŒè¯ç å’ŒTokenç®¡ç†æœºåˆ¶  
âœ… **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™ç¬¬ä¸‰æ–¹ç™»å½•å’Œæ‰©å±•å­—æ®µ  
âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå…³é”®å­—æ®µå»ºç«‹ç´¢å¼•  
âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šå¤–é”®çº¦æŸå’Œæ£€æŸ¥çº¦æŸ  
âœ… **æ—¥å¿—å®Œæ•´**ï¼šå®Œæ•´çš„ç™»å½•æ—¥å¿—è®°å½•  

### æ•°æ®é‡é¢„ä¼°

| è¡¨å | é¢„ä¼°è®°å½•æ•° | è¯´æ˜ |
|------|------------|------|
| `users` | 10ä¸‡+ | ç”¨æˆ·è¡¨ |
| `sms_verification_codes` | 100ä¸‡+ | å®šæœŸæ¸…ç† |
| `user_sessions` | 50ä¸‡+ | å®šæœŸæ¸…ç† |
| `login_logs` | 500ä¸‡+ | å®šæœŸå½’æ¡£ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-06  
**ç»´æŠ¤è€…**ï¼šTennis-Frogå¼€å‘å›¢é˜Ÿ

